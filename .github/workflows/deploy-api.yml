name: CD - Deploy - API
on:
  workflow_dispatch:
    inputs:
      api_log_lvl:
        description: Log level for the API
        type: choice
        options:
        - debug
        - info
        - warn
        default: info
      show_upcoming_changes:
        description: Show upcoming changes (enables upcoming certifications and challenges)
        type: boolean
        default: false
concurrency:
  group: deploy-api-${{ github.ref_name }}
  cancel-in-progress: false
jobs:
  setup-jobs:
    name: Setup Jobs
    runs-on: ubuntu-latest
    outputs:
      site_tld: ${{ steps.setup.outputs.site_tld }}
      tgt_env_short: ${{ steps.setup.outputs.tgt_env_short }}
      tgt_env_long: ${{ steps.setup.outputs.tgt_env_long }}
      api_log_lvl: ${{ steps.setup.outputs.api_log_lvl }}
      show_upcoming_changes: ${{ steps.setup.outputs.show_upcoming_changes }}
    steps:
    - name: Setup
      id: setup
      run: "BRANCH=\"${{ github.ref_name }}\"\necho \"Current branch: $BRANCH\"\n\n\
        # Convert boolean input to string 'true' or 'false'\nif [[ \"${{ inputs.show_upcoming_changes\
        \ }}\" == \"true\" ]]; then\n  echo \"show_upcoming_changes=true\" >> $GITHUB_OUTPUT\n\
        else\n  echo \"show_upcoming_changes=false\" >> $GITHUB_OUTPUT\nfi\n\ncase\
        \ \"$BRANCH\" in\n  \"prod-current\")\n    echo \"site_tld=org\" >> $GITHUB_OUTPUT\n\
        \    echo \"tgt_env_short=prd\" >> $GITHUB_OUTPUT\n    echo \"tgt_env_long=production\"\
        \ >> $GITHUB_OUTPUT\n    echo \"api_log_lvl=${{ inputs.api_log_lvl || 'info'\
        \ }}\" >> $GITHUB_OUTPUT\n    ;;\n  *)\n    echo \"site_tld=dev\" >> $GITHUB_OUTPUT\n\
        \    echo \"tgt_env_short=stg\" >> $GITHUB_OUTPUT\n    echo \"tgt_env_long=staging\"\
        \ >> $GITHUB_OUTPUT\n    echo \"api_log_lvl=${{ inputs.api_log_lvl || 'info'\
        \ }}\" >> $GITHUB_OUTPUT\n    ;;\nesac\n"
  build:
    name: Build & Push
    needs: setup-jobs
    uses: ./.github/workflows/docker-docr.yml
    with:
      site_tld: ${{ needs.setup-jobs.outputs.site_tld }}
      app: api
      show_upcoming_changes: ${{ needs.setup-jobs.outputs.show_upcoming_changes }}
    secrets: inherit
  deploy:
    name: Deploy to Docker Swarm -- ${{ needs.setup-jobs.outputs.tgt_env_short }}
    runs-on: ubuntu-latest
    needs:
    - setup-jobs
    - build
    env:
      TS_USERNAME: ${{ secrets.TS_USERNAME }}
      TS_MACHINE_NAME: ${{ secrets.TS_MACHINE_NAME }}
    permissions:
      deployments: write
    environment:
      name: ${{ needs.setup-jobs.outputs.tgt_env_short }}-api
    steps:
    - name: Setup and connect to Tailscale network
      uses: tailscale/github-action@53acf823325fe9ca47f4cdaa951f90b4b0de5bb9
      with:
        oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
        oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
        hostname: gha-${{needs.setup-jobs.outputs.tgt_env_short}}-api-ci-${{ github.run_id
          }}
        tags: tag:ci
        version: latest
    - name: Wait for Tailscale Network Readiness
      run: "echo \"Waiting for Tailscale network to be ready...\"\nmax_wait=60\nelapsed=0\n\
        \nwhile [ $elapsed -lt $max_wait ]; do\n  if tailscale status --json | jq\
        \ -e '.BackendState == \"Running\"' > /dev/null 2>&1; then\n    echo \"Tailscale\
        \ network is ready\"\n    break\n  fi\n  sleep 2\n  elapsed=$((elapsed + 2))\n\
        done\n\nif [ $elapsed -ge $max_wait ]; then\n  echo \"Tailscale network not\
        \ ready after ${max_wait}s\"\n  exit 1\nfi\n"
    - name: Configure SSH & Check Connection
      run: "mkdir -p ~/.ssh\necho \"Host *\n  UserKnownHostsFile=/dev/null\n  StrictHostKeyChecking\
        \ no\" > ~/.ssh/config\nchmod 644 ~/.ssh/config\n\nvalidate_connection() {\n\
        \  local machine_name=$1\n  local max_retries=3\n  local retry_delay=5\n \
        \ \n  for attempt in $(seq 1 $max_retries); do\n    echo \"Connection attempt\
        \ $attempt/$max_retries to $machine_name\"\n    \n    if ! tailscale status\
        \ | grep -q \"$machine_name\"; then\n      echo \"Machine $machine_name not\
        \ found in Tailscale network\"\n      if [ $attempt -eq $max_retries ]; then\n\
        \        return 1\n      fi\n      sleep $retry_delay\n      continue\n  \
        \  fi\n    \n    MACHINE_IP=$(tailscale ip -4 $machine_name)\n    if ssh -o\
        \ ConnectTimeout=10 -o BatchMode=yes $TS_USERNAME@$MACHINE_IP \"echo 'Connection\
        \ test'; docker --version\" > /dev/null 2>&1; then\n      echo \"Successfully\
        \ validated connection to $machine_name\"\n      return 0\n    fi\n    \n\
        \    echo \"SSH validation failed for $machine_name\"\n    if [ $attempt -lt\
        \ $max_retries ]; then\n      sleep $retry_delay\n    fi\n  done\n  \n  echo\
        \ \"Failed to establish connection to $machine_name after $max_retries attempts\"\
        \n  return 1\n}\n\necho -e \"\\nLOG:Validating connection to $TS_MACHINE_NAME...\"\
        \nif ! validate_connection \"$TS_MACHINE_NAME\"; then\n  echo \"Error: Failed\
        \ to establish reliable connection to $TS_MACHINE_NAME\"\n  exit 1\nfi\n"
    - name: Deploy with Docker Stack
      env:
        AGE_ENCRYPTED_ASC_SECRETS: ${{ secrets.AGE_ENCRYPTED_ASC_SECRETS }}
        AGE_SECRET_KEY: ${{ secrets.AGE_SECRET_KEY }}
        DEPLOYMENT_VERSION: ${{ needs.build.outputs.tagname }}
        DEPLOYMENT_ENV: ${{ needs.setup-jobs.outputs.tgt_env_long }}
        DEPLOYMENT_TLD: ${{ needs.setup-jobs.outputs.site_tld }}
        FCC_API_LOG_LEVEL: ${{ needs.setup-jobs.outputs.api_log_lvl }}
        SHOW_UPCOMING_CHANGES: ${{ needs.setup-jobs.outputs.show_upcoming_changes
          }}
        STACK_NAME: ${{ needs.setup-jobs.outputs.tgt_env_short }}-api
      run: "REMOTE_SCRIPT=\"\n  set -e\n  trap 'rm -f .env age.key secrets.age.asc\
        \ .env.tmp' EXIT\n  echo -e '\\nLOG:Deploying API to $TS_MACHINE_NAME...'\n\
        \  cd /home/$TS_USERNAME/docker-swarm-config/stacks/api\n\n  echo -e '\\nLOG:Checking\
        \ if age is installed...'\n  which age > /dev/null\n\n  echo -e '\\nLOG:Decrypting\
        \ secrets...'\n  echo \\\"$AGE_ENCRYPTED_ASC_SECRETS\\\" > secrets.age.asc\n\
        \  echo \\\"$AGE_SECRET_KEY\\\" > age.key && chmod 600 age.key\n  age --identity\
        \ age.key --decrypt secrets.age.asc > .env\n  rm -f age.key secrets.age.asc\n\
        \n  echo -e '\\nLOG:Cleaning up .env file...'\n  touch .env.tmp\n  while IFS=\
        \ read -r line; do\n    if [[ \\$line =~ ^[A-Za-z0-9_]+=.*$ ]]; then\n   \
        \   # Extract the key (part before the first =)\n      key=\\${line%%=*}\n\
        \      # Remove any previous line with this key\n      sed -i \\\"/^\\${key}=/d\\\
        \" .env.tmp\n    fi\n    # Append the current line\n    echo \\\"\\$line\\\
        \" >> .env.tmp\n  done < .env\n  mv .env.tmp .env\n\n  echo -e '\\nLOG:Adding\
        \ deployment variables...'\n  {\n    echo \\\"DEPLOYMENT_VERSION=$DEPLOYMENT_VERSION\\\
        \"\n    echo \\\"DEPLOYMENT_TLD=$DEPLOYMENT_TLD\\\"\n    echo \\\"DEPLOYMENT_ENV=$DEPLOYMENT_ENV\\\
        \"\n    echo \\\"FCC_API_LOG_LEVEL=$FCC_API_LOG_LEVEL\\\"\n    echo \\\"SHOW_UPCOMING_CHANGES=$SHOW_UPCOMING_CHANGES\\\
        \"\n  } >> .env\n\n  echo -e '\\nLOG:Sourcing environment...'\n  REQUIRED_VARS=(\n\
        \    \\\"DOCKER_REGISTRY\\\"\n    \\\"MONGOHQ_URL\\\"\n    \\\"SENTRY_DSN\\\
        \"\n    \\\"SENTRY_ENVIRONMENT\\\"\n    \\\"AUTH0_CLIENT_ID\\\"\n    \\\"\
        AUTH0_CLIENT_SECRET\\\"\n    \\\"AUTH0_DOMAIN\\\"\n    \\\"JWT_SECRET\\\"\n\
        \    \\\"COOKIE_SECRET\\\"\n    \\\"COOKIE_DOMAIN\\\"\n    \\\"SES_ID\\\"\n\
        \    \\\"SES_SECRET\\\"\n    \\\"GROWTHBOOK_FASTIFY_API_HOST\\\"\n    \\\"\
        GROWTHBOOK_FASTIFY_CLIENT_KEY\\\"\n    \\\"HOME_LOCATION\\\"\n    \\\"API_LOCATION\\\
        \"\n    \\\"STRIPE_SECRET_KEY\\\"\n    \\\"LOKI_URL\\\"\n    \\\"DEPLOYMENT_VERSION\\\
        \"\n    \\\"DEPLOYMENT_TLD\\\"\n    \\\"DEPLOYMENT_ENV\\\"\n    \\\"FCC_API_LOG_LEVEL\\\
        \"\n  )\n\n  while IFS='=' read -r key value; do\n    if [[ -n \\\"\\$key\\\
        \" && ! \\\"\\$key\\\" =~ ^# ]]; then\n      export \\\"\\${key}=\\${value}\\\
        \"\n    fi\n  done < .env\n\n  MISSING_VARS=()\n  for var in \\\"\\${REQUIRED_VARS[@]}\\\
        \"; do\n    if [[ -z \\\"\\${!var}\\\" ]]; then\n      MISSING_VARS+=(\\\"\
        \\$var\\\")\n    fi\n  done\n\n  if [[ \\${#MISSING_VARS[@]} -gt 0 ]]; then\n\
        \    echo \\\"ERROR: The following required environment variables are missing\
        \ or empty:\\\"\n    for var in \\\"\\${MISSING_VARS[@]}\\\"; do\n      echo\
        \ \\\"  - \\$var\\\"\n    done\n    exit 1\n  fi\n\n  rm -rf .env\n\n  echo\
        \ -e '\\nLOG:Validating deployment version...'\n  if [[ \\\"\\$DEPLOYMENT_VERSION\\\
        \" != \\\"$DEPLOYMENT_VERSION\\\" ]]; then\n    echo \\\"Error: Version mismatch.\
        \ Expected: $DEPLOYMENT_VERSION, Got: \\$DEPLOYMENT_VERSION\\\"\n    exit\
        \ 1\n  fi\n  env | grep -E 'DEPLOYMENT_VERSION'\n\n  echo -e '\\nLOG:Checking\
        \ stack configuration...'\n  CONFIG_OUTPUT=\\\"/dev/null\\\"\n  if [[ \\\"\
        \\$FCC_API_LOG_LEVEL\\\" == \\\"debug\\\" ]]; then\n    CONFIG_FILENAME=\\\
        \"debug-docker-stack-config-\\${DEPLOYMENT_VERSION}.yml\\\"\n    echo -e '\\\
        nLOG:Saving stack configuration for debugging...'\n    CONFIG_OUTPUT=\\\"\\\
        $CONFIG_FILENAME\\\"\n  fi\n  docker stack config -c stack-api.yml > \\$CONFIG_OUTPUT\n\
        \n  echo -e '\\nLOG:Deploying stack...'\n  docker stack deploy -c stack-api.yml\
        \ --prune --with-registry-auth --detach=false $STACK_NAME\n\n  echo -e '\\\
        nLOG:Finished deployment.'\n\"\nMACHINE_IP=$(tailscale ip -4 $TS_MACHINE_NAME)\n\
        ssh $TS_USERNAME@$MACHINE_IP \"$REMOTE_SCRIPT\"\n"
