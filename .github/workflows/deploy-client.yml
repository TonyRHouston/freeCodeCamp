name: CD - Deploy - Clients
on:
  workflow_dispatch:
    inputs:
      target_language:
        description: Target language (or "all" for all languages)
        type: choice
        options:
        - all
        - english
        - chinese
        - espanol
        - chinese-traditional
        - italian
        - portuguese
        - ukrainian
        - japanese
        - german
        - swahili
        default: all
      show_upcoming_changes:
        description: Show upcoming changes (enables upcoming certifications and challenges)
        type: boolean
        default: false
jobs:
  setup-jobs:
    name: Setup Jobs
    runs-on: ubuntu-latest
    outputs:
      site_tld: ${{ steps.setup.outputs.site_tld }}
      tgt_env_short: ${{ steps.setup.outputs.tgt_env_short }}
      tgt_env_long: ${{ steps.setup.outputs.tgt_env_long }}
      tgt_env_branch: ${{ steps.setup.outputs.tgt_env_branch }}
      show_upcoming_changes: ${{ steps.setup.outputs.show_upcoming_changes }}
    steps:
    - name: Setup
      id: setup
      run: "BRANCH=\"${{ github.ref_name }}\"\necho \"Current branch: $BRANCH\"\n\n\
        # Convert boolean input to string 'true' or 'false'\nif [[ \"${{ inputs.show_upcoming_changes\
        \ }}\" == \"true\" ]]; then\n  echo \"show_upcoming_changes=true\" >> $GITHUB_OUTPUT\n\
        else\n  echo \"show_upcoming_changes=false\" >> $GITHUB_OUTPUT\nfi\n\ncase\
        \ \"$BRANCH\" in\n  \"prod-current\")\n    echo \"site_tld=org\" >> $GITHUB_OUTPUT\n\
        \    echo \"tgt_env_short=prd\" >> $GITHUB_OUTPUT\n    echo \"tgt_env_long=production\"\
        \ >> $GITHUB_OUTPUT\n    echo \"tgt_env_branch=prod-current\" >> $GITHUB_OUTPUT\n\
        \    ;;\n  *)\n    echo \"site_tld=dev\" >> $GITHUB_OUTPUT\n    echo \"tgt_env_short=stg\"\
        \ >> $GITHUB_OUTPUT\n    echo \"tgt_env_long=staging\" >> $GITHUB_OUTPUT\n\
        \    echo \"tgt_env_branch=prod-staging\" >> $GITHUB_OUTPUT\n    ;;\nesac\n"
  setup-matrix:
    name: Setup Matrix
    runs-on: ubuntu-latest
    needs: setup-jobs
    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
    steps:
    - name: Setup Matrix
      uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
      id: matrix
      env:
        TARGET_LANG: ${{ inputs.target_language }}
      with:
        script: "// Constants\nconst NODE_VERSION = 24;\n\n// Input sanitization and\
          \ validation\nconst rawTargetLang = process.env.TARGET_LANG || 'all';\n\
          const targetLang = rawTargetLang.trim().toLowerCase();\nconsole.log(`Target\
          \ language: ${targetLang}`);\n\n// Language mappings (single source of truth)\n\
          const languageMap = {\n  'english': 'eng',\n  'chinese': 'chn',\n  'espanol':\
          \ 'esp',\n  'chinese-traditional': 'cnt',\n  'italian': 'ita',\n  'portuguese':\
          \ 'por',\n  'ukrainian': 'ukr',\n  'japanese': 'jpn',\n  'german': 'ger',\n\
          \  'swahili': 'swa'\n};\n\nconst allLanguages = Object.keys(languageMap);\n\
          let matrix;\n\nif (targetLang === 'all') {\n  console.log('Building matrix\
          \ for all languages');\n  console.log(`Available languages: ${allLanguages.join(',\
          \ ')}`);\n\n  // Build include array for all languages\n  const include\
          \ = allLanguages.map(lang => ({\n    'node-version': NODE_VERSION,\n   \
          \ 'lang-name-full': lang,\n    'lang-name-short': languageMap[lang]\n  }));\n\
          \n  matrix = {\n    include: include\n  };\n\n} else {\n  console.log(`Building\
          \ matrix for single language: ${targetLang}`);\n\n  // Validate language\
          \ selection\n  if (!languageMap[targetLang]) {\n    const errorMsg = `Unknown\
          \ language '${targetLang}'. Available: ${allLanguages.join(', ')}`;\n  \
          \  console.error(errorMsg);\n    core.setFailed(errorMsg);\n    return;\n\
          \  }\n\n  console.log(`Processing: ${targetLang} -> ${languageMap[targetLang]}`);\n\
          \n  // Create single language matrix\n  matrix = {\n    include: [{\n  \
          \    'node-version': NODE_VERSION,\n      'lang-name-full': targetLang,\n\
          \      'lang-name-short': languageMap[targetLang]\n    }]\n  };\n}\n\n//\
          \ Final validation\nif (!matrix || !matrix.include || matrix.include.length\
          \ === 0) {\n  core.setFailed('Generated matrix is empty or invalid');\n\
          \  return;\n}\n\nconsole.log('Generated matrix:');\nconsole.log(JSON.stringify(matrix,\
          \ null, 2));\nconsole.log(`Matrix will create ${matrix.include.length} job(s)`);\n\
          \n// Set output for GitHub Actions\ncore.setOutput('matrix', JSON.stringify(matrix));\n"
  client:
    name: Clients - [${{ needs.setup-jobs.outputs.tgt_env_short }}] [${{ matrix.lang-name-short
      }}]
    needs:
    - setup-jobs
    - setup-matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup-matrix.outputs.matrix) }}
    permissions:
      deployments: write
      contents: read
    environment:
      name: ${{ needs.setup-jobs.outputs.tgt_env_short }}-clients
    env:
      TS_USERNAME: ${{ secrets.TS_USERNAME }}
      TS_MACHINE_NAME_PREFIX: ${{ secrets.TS_MACHINE_NAME_PREFIX }}
    steps:
    - name: Checkout
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
      with:
        submodules: recursive
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238
      with:
        node-version: ${{ matrix.node-version }}
    - name: Install pnpm
      uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061
      id: pnpm-install
      with:
        run_install: false
    - name: Language specific ENV - [${{ matrix.lang-name-full }}]
      run: "if [ \"${{ matrix.lang-name-full }}\" = \"english\" ]; then\n  echo \"\
        HOME_LOCATION=https://www.freecodecamp.${{ needs.setup-jobs.outputs.site_tld\
        \ }}\" >> $GITHUB_ENV\n  echo \"NEWS_LOCATION=https://www.freecodecamp.${{\
        \ needs.setup-jobs.outputs.site_tld }}/news\" >> $GITHUB_ENV\nelse\n  echo\
        \ \"HOME_LOCATION=https://www.freecodecamp.${{ needs.setup-jobs.outputs.site_tld\
        \ }}/${{ matrix.lang-name-full }}\" >> $GITHUB_ENV\n  echo \"NEWS_LOCATION=https://www.freecodecamp.${{\
        \ needs.setup-jobs.outputs.site_tld }}/${{ matrix.lang-name-full }}/news\"\
        \ >> $GITHUB_ENV\nfi\necho \"CLIENT_LOCALE=${{ matrix.lang-name-full }}\"\
        \ >> $GITHUB_ENV\necho \"CURRICULUM_LOCALE=${{ matrix.lang-name-full }}\"\
        \ >> $GITHUB_ENV\n"
    - name: Create deployment version
      id: deployment-version
      run: 'DEPLOYMENT_VERSION=$(git rev-parse --short HEAD)-$(date +%Y%m%d)-$(date
        +%H%M)

        echo "DEPLOYMENT_VERSION=$DEPLOYMENT_VERSION" >> $GITHUB_ENV

        echo "DEPLOYMENT_VERSION=$DEPLOYMENT_VERSION" >> $GITHUB_OUTPUT

        '
    - name: Install and Build
      env:
        API_LOCATION: https://api.freecodecamp.${{ needs.setup-jobs.outputs.site_tld
          }}
        ALGOLIA_API_KEY: ${{ secrets.ALGOLIA_API_KEY }}
        ALGOLIA_APP_ID: ${{ secrets.ALGOLIA_APP_ID }}
        GROWTHBOOK_URI: ${{ secrets.GROWTHBOOK_URI }}
        FORUM_LOCATION: https://forum.freecodecamp.org
        PATREON_CLIENT_ID: ${{ secrets.PATREON_CLIENT_ID }}
        PAYPAL_CLIENT_ID: ${{ secrets.PAYPAL_CLIENT_ID }}
        STRIPE_PUBLIC_KEY: ${{ secrets.STRIPE_PUBLIC_KEY }}
        SHOW_UPCOMING_CHANGES: ${{ needs.setup-jobs.outputs.show_upcoming_changes
          }}
        FREECODECAMP_NODE_ENV: production
        DEPLOYMENT_ENV: ${{ needs.setup-jobs.outputs.tgt_env_long }}
      run: 'pnpm install

        pnpm run build

        '
    - name: Tar Files
      run: tar -czf client-${{ matrix.lang-name-short }}.tar client/public
    - name: Setup and connect to Tailscale network
      uses: tailscale/github-action@53acf823325fe9ca47f4cdaa951f90b4b0de5bb9
      with:
        oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
        oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
        hostname: gha-${{needs.setup-jobs.outputs.tgt_env_short}}-clients-ci-${{ github.run_id
          }}
        tags: tag:ci
        version: latest
    - name: Wait for Tailscale Network Readiness
      run: "echo \"Waiting for Tailscale network to be ready...\"\nmax_wait=60\nelapsed=0\n\
        \nwhile [ $elapsed -lt $max_wait ]; do\n  if tailscale status --json | jq\
        \ -e '.BackendState == \"Running\"' > /dev/null 2>&1; then\n    echo \"Tailscale\
        \ network is ready\"\n    break\n  fi\n  sleep 2\n  elapsed=$((elapsed + 2))\n\
        done\n\nif [ $elapsed -ge $max_wait ]; then\n  echo \"Tailscale network not\
        \ ready after ${max_wait}s\"\n  exit 1\nfi\n"
    - name: Configure SSH & Check Connection
      run: "mkdir -p ~/.ssh\necho \"Host *\n  UserKnownHostsFile=/dev/null\n  StrictHostKeyChecking\
        \ no\" > ~/.ssh/config\nchmod 644 ~/.ssh/config\n\nvalidate_connection() {\n\
        \  local machine_name=$1\n  local max_retries=3\n  local retry_delay=5\n \
        \ \n  for attempt in $(seq 1 $max_retries); do\n    echo \"Connection attempt\
        \ $attempt/$max_retries to $machine_name\"\n    \n    if ! tailscale status\
        \ | grep -q \"$machine_name\"; then\n      echo \"Machine $machine_name not\
        \ found in Tailscale network\"\n      if [ $attempt -eq $max_retries ]; then\n\
        \        return 1\n      fi\n      sleep $retry_delay\n      continue\n  \
        \  fi\n    \n    MACHINE_IP=$(tailscale ip -4 $machine_name)\n    if ssh -o\
        \ ConnectTimeout=10 -o BatchMode=yes $TS_USERNAME@$MACHINE_IP \"echo 'Connection\
        \ test'; uptime\" > /dev/null 2>&1; then\n      echo \"Successfully validated\
        \ connection to $machine_name\"\n      return 0\n    fi\n    \n    echo \"\
        SSH validation failed for $machine_name\"\n    if [ $attempt -lt $max_retries\
        \ ]; then\n      sleep $retry_delay\n    fi\n  done\n  \n  echo \"Failed to\
        \ establish connection to $machine_name after $max_retries attempts\"\n  return\
        \ 1\n}\n\necho -e \"\\nLOG:Validating connections to all machines...\"\nfor\
        \ i in {0..1}; do\n  TS_MACHINE_NAME=${TS_MACHINE_NAME_PREFIX}-${{ matrix.lang-name-short\
        \ }}-${i}\n  echo \"Validating connection to $TS_MACHINE_NAME\"\n  if ! validate_connection\
        \ \"$TS_MACHINE_NAME\"; then\n    echo \"Error: Failed to establish reliable\
        \ connection to $TS_MACHINE_NAME\"\n    exit 1\n  fi\ndone\necho \"All machine\
        \ connections validated successfully\"\n"
    - name: Upload and Deploy
      run: "for i in {0..1}; do\n  TS_MACHINE_NAME=${TS_MACHINE_NAME_PREFIX}-${{ matrix.lang-name-short\
        \ }}-${i}\n  CURRENT_DATE=$(date +%Y%m%d)\n  CLIENT_SRC=client-${{ matrix.lang-name-short\
        \ }}.tar\n  CLIENT_DST=/tmp/client-${{ matrix.lang-name-short }}-${CURRENT_DATE}-${{\
        \ github.run_id }}.tar\n  CLIENT_BINARIES=${{needs.setup-jobs.outputs.tgt_env_short}}-release-$CURRENT_DATE-${{\
        \ github.run_id }}\n\n  echo -e \"\\nLOG:Uploading client archive to $TS_MACHINE_NAME...\"\
        \n  MACHINE_IP=$(tailscale ip -4 $TS_MACHINE_NAME)\n  scp $CLIENT_SRC $TS_USERNAME@$MACHINE_IP:$CLIENT_DST\n\
        \n  REMOTE_SCRIPT=\"\n    set -e\n    echo -e '\\nLOG: Deploying client -\
        \ $CLIENT_BINARIES to $TS_MACHINE_NAME...'\n\n    echo -e '\\nLOG:Extracting\
        \ client archive...'\n    mkdir -p /home/$TS_USERNAME/client/releases/$CLIENT_BINARIES\n\
        \    tar -xzf $CLIENT_DST -C /home/$TS_USERNAME/client/releases/$CLIENT_BINARIES\
        \ --strip-components=2\n\n    echo -e '\\nLOG:Cleaning up client archive...'\n\
        \    rm $CLIENT_DST\n\n    echo -e '\\nLOG:Checking client archive size...'\n\
        \    du -sh /home/$TS_USERNAME/client/releases/$CLIENT_BINARIES\n\n    echo\
        \ -e '\\nLOG:Environment setup...'\n    cd /home/$TS_USERNAME/client\n   \
        \ export NVM_DIR=\\$HOME/.nvm && [ -s \"\\$NVM_DIR/nvm.sh\" ] && source \"\
        \\$NVM_DIR/nvm.sh\"\n    echo -e '\\nLOG:Checking available Node.js versions...'\n\
        \    nvm ls | grep 'default'\n    echo -e '\\nLOG:Checking Node.js version...'\n\
        \    node --version\n\n    echo -e '\\nLOG:Installing serve...'\n    npm install\
        \ -g serve@13\n\n    echo -e '\\nLOG:Primary client setup...'\n    rm -f client-start-primary.sh\n\
        \    echo \\\"serve -c ../../serve.json releases/$CLIENT_BINARIES -p 50505\\\
        \" >> client-start-primary.sh\n    chmod +x client-start-primary.sh\n    pm2\
        \ delete client-primary || true\n    pm2 start ./client-start-primary.sh --name\
        \ client-primary\n    echo -e '\\nLOG:Primary client setup completed.'\n\n\
        \    pm2 ls\n\n    echo -e '\\nLOG:Secondary client setup...'\n    rm -f client-start-secondary.sh\n\
        \    echo \\\"serve -c ../../serve.json releases/$CLIENT_BINARIES -p 52525\\\
        \" >> client-start-secondary.sh\n    chmod +x client-start-secondary.sh\n\
        \    pm2 delete client-secondary || true\n    pm2 start ./client-start-secondary.sh\
        \ --name client-secondary\n    echo -e '\\nLOG:Secondary client setup completed.'\n\
        \n    pm2 ls\n    pm2 save\n\n    echo -e '\\nLOG:Finished deployment.'\n\
        \  \"\n  ssh $TS_USERNAME@$MACHINE_IP \"$REMOTE_SCRIPT\"\ndone\n"
