name: CI - Node.js
on:
  workflow_dispatch: {}
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.event.workflow_run.head_branch
    || github.ref }}
  cancel-in-progress: ${{ !contains(github.ref, 'main') && !contains(github.ref, 'prod-')
    }}
permissions:
  contents: read
jobs:
  lint:
    name: Lint
    if: github.event_name != 'pull_request' || github.event.pull_request.user.login
      != 'renovate[bot]'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version:
        - 24
      fail-fast: false
    steps:
    - name: Checkout
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
      with:
        submodules: recursive
    - name: Check number of lockfiles
      run: "if [ $(find . -name 'package-lock.json' | grep -vc -e 'node_modules')\
        \ -gt 0 ]\nthen\n  echo -e 'Error: found package-lock files in the repository.\\\
        nWe use pnpm workspaces to manage packages so all dependencies should be added\
        \ via pnpm add'\n  exit 1\nfi\n"
    - name: Check format of sample.env
      run: docker run --rm -v `pwd`:/app -w /app dotenvlinter/dotenv-linter check
        --ignore-checks UnorderedKey sample.env
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238
      with:
        node-version: ${{ matrix.node-version }}
    - name: Install pnpm
      uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061
      id: pnpm-install
      with:
        run_install: false
    - name: Setup Turbo Cache
      uses: ./.github/actions/setup-turbo-cache
      with:
        turbo-token: ${{ secrets.TURBO_TOKEN }}
        turbo-signature-key: ${{ secrets.TURBO_REMOTE_CACHE_SIGNATURE_KEY }}
    - name: Set Environment variables
      run: 'sed ''/^[[:space:]]*#/d; /^$/d'' sample.env >> $GITHUB_ENV

        cat sample.env

        '
    - name: Install node_modules
      run: pnpm install
    - name: Check formatting
      run: 'pnpm prettier --check . || [ $? -eq 1 ] && printf "\nTip: Run ''pnpm run
        format'' in your terminal to fix this.\n\n"

        '
    - name: Lint Source Files
      run: 'echo pnpm version $(pnpm -v)

        pnpm lint

        '
  build:
    name: Build
    needs: lint
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version:
        - 24
    steps:
    - name: Checkout
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
      with:
        submodules: recursive
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238
      with:
        node-version: ${{ matrix.node-version }}
    - name: Install pnpm
      uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061
      id: pnpm-install
      with:
        run_install: false
    - name: Setup Turbo Cache
      uses: ./.github/actions/setup-turbo-cache
      with:
        turbo-token: ${{ secrets.TURBO_TOKEN }}
        turbo-signature-key: ${{ secrets.TURBO_REMOTE_CACHE_SIGNATURE_KEY }}
    - name: Set freeCodeCamp Environment Variables
      run: 'sed ''/^[[:space:]]*#/d; /^$/d'' sample.env >> $GITHUB_ENV

        '
    - name: Install and Build
      run: 'pnpm install

        pnpm run build

        '
  test:
    name: Test
    needs: build
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node-version:
        - 24
    steps:
    - name: Checkout
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
      with:
        submodules: recursive
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238
      with:
        node-version: ${{ matrix.node-version }}
    - name: Install pnpm
      uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061
      id: pnpm-install
      with:
        run_install: false
    - name: Setup Turbo Cache
      uses: ./.github/actions/setup-turbo-cache
      with:
        turbo-token: ${{ secrets.TURBO_TOKEN }}
        turbo-signature-key: ${{ secrets.TURBO_REMOTE_CACHE_SIGNATURE_KEY }}
    - name: Set Environment variables
      run: 'sed ''/^[[:space:]]*#/d; /^$/d'' sample.env >> $GITHUB_ENV

        cat sample.env

        '
    - name: Start MongoDB
      run: docker compose -f docker/docker-compose.yml up -d
    - name: Install Dependencies
      run: 'echo pnpm version $(pnpm -v)

        pnpm install

        '
    - name: Install Chrome for Puppeteer
      run: pnpm -F=curriculum install-puppeteer
    - name: Run Tests
      run: pnpm test
  test-upcoming:
    name: Test - Upcoming Changes
    needs: build
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node-version:
        - 24
    steps:
    - name: Checkout
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
      with:
        submodules: recursive
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238
      with:
        node-version: ${{ matrix.node-version }}
    - name: Install pnpm
      uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061
      id: pnpm-install
      with:
        run_install: false
    - name: Setup Turbo Cache
      uses: ./.github/actions/setup-turbo-cache
      with:
        turbo-token: ${{ secrets.TURBO_TOKEN }}
        turbo-signature-key: ${{ secrets.TURBO_REMOTE_CACHE_SIGNATURE_KEY }}
    - name: Set Environment variables
      run: 'sed ''/^[[:space:]]*#/d; /^$/d'' sample.env >> $GITHUB_ENV

        echo ''SHOW_UPCOMING_CHANGES=true'' >> $GITHUB_ENV

        '
    - name: Start MongoDB
      run: docker compose -f docker/docker-compose.yml up -d
    - name: Install Dependencies
      run: 'echo pnpm version $(pnpm -v)

        pnpm install

        '
    - name: Install Chrome for Puppeteer
      run: pnpm -F=curriculum install-puppeteer
    - name: Run Tests
      run: pnpm test
  test-localization:
    name: Test - i18n
    needs: build
    runs-on: ubuntu-latest
    if: github.event.pull_request.user.login == 'camperbot' && github.head_ref ==
      'chore/update-i18n-curriculum-submodule'
    strategy:
      fail-fast: false
      matrix:
        node-version:
        - 24
        locale:
        - portuguese
        - italian
    steps:
    - name: Checkout
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
      with:
        submodules: recursive
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238
      with:
        node-version: ${{ matrix.node-version }}
    - name: Install pnpm
      uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061
      id: pnpm-install
      with:
        run_install: false
    - name: Setup Turbo Cache
      uses: ./.github/actions/setup-turbo-cache
      with:
        turbo-token: ${{ secrets.TURBO_TOKEN }}
        turbo-signature-key: ${{ secrets.TURBO_REMOTE_CACHE_SIGNATURE_KEY }}
    - name: Set Environment variables
      run: 'sed ''/^[[:space:]]*#/d; /^$/d'' sample.env >> $GITHUB_ENV

        cat sample.env

        '
    - name: Start MongoDB
      uses: supercharge/mongodb-github-action@315db7fe45ac2880b7758f1933e6e5d59afd5e94
      with:
        mongodb-version: 8.0
        mongodb-replica-set: test-rs
        mongodb-port: 27017
    - name: Install Dependencies
      env:
        CURRICULUM_LOCALE: ${{ matrix.locale }}
        CLIENT_LOCALE: ${{ matrix.locale }}
      run: 'echo pnpm version $(pnpm -v)

        pnpm install

        '
    - name: Build Client in ${{ matrix.locale }}
      env:
        CURRICULUM_LOCALE: ${{ matrix.locale }}
        CLIENT_LOCALE: ${{ matrix.locale }}
      run: 'pnpm run build

        '
    - name: Install Chrome for Puppeteer
      run: pnpm -F=curriculum install-puppeteer
    - name: Run Tests
      env:
        CURRICULUM_LOCALE: ${{ matrix.locale }}
        CLIENT_LOCALE: ${{ matrix.locale }}
      run: pnpm test
